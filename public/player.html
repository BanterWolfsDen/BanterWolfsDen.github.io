<html>
  <head>
    <link href="./playlist.css" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
  </head>  
  <body>
    <div id="status" style="position: absolute; top: 100px; left: 100px; z-index: 99; background: white">
      Here is the status!!!
    </div>
    <div id="player">
      
    </div>
    <script>
      
      const Responses = {
        DOWN_VOLUME: 'down-volume',
        UP_VOLUME: 'up-volume'
      }
      const hostUrl = 'sq-synced-videoplayer.glitch.me';
      class Player {
        constructor(){
          this.init();
        }
        async init() {
          this.video = document.getElementById("videoFrame");
          this.urlParams = new URLSearchParams(window.location.search);      
          this.start = this.urlParams.get('start');    
          var userStr = this.urlParams.get("user").split("-_-");
          window.user = {
            id: userStr[0],
            name: userStr[1]
          }
          await this.setupWebsocket();
        }
        setupWebsocket(){
          return new Promise(resolve => {
            this.ws = new WebSocket('wss://' + hostUrl + '/');
            this.ws.onopen = (event) => {
              console.log("Websocket connected!");
              this.sendMessage({path: "user-video-player", data: window.user});
              resolve();
            };
            this.ws.onmessage = (event) => {
              if(typeof event.data === 'string'){
                this.parseMessage(event.data);
              }
            }
            this.ws.onclose =  (event) => {
              console.log("Websocket closed...");
              setTimeout(() => {
                if(window.isBanter) {
                  this.setupWebsocket();
                }else{
                  window.location.reload();
                } 
              }, 1000);
            };
          });
        } 
        parseMessage(msg) {
          const json = JSON.parse(msg);
          const vol = player.getVolume();
          switch(json.path) {
            case Responses.DOWN_VOLUME:
              if(vol > 0) {
                this.player.setVolume(player.getVolume()-10)
              }
              break;
            case Responses.UP_VOLUME:
              if(vol < 100) {
                this.player.setVolume(player.getVolume()+10)
              }
              break;
          }
        }
        sendMessage(msg){
          this.ws.send(JSON.stringify(msg));
        }
        onYouTubeIframeAPIReady() {
          this.player = new YT.Player('player', {
            height: window.innerHeight,
            width: window.innerWidth,
            videoId: this.getId(decodeURIComponent(this.urlParams.get('youtube'))),
            playerVars: {
              'playsinline': 1,
              'autoplay': 0,
              'disablekb': 1,
              'modestbranding': true,
              'origin': 'https://sq-synced-videoplayer.glitch.me',
              'start': this.start ? Number(this.start) : 0
            },
            events: {
              'onReady': (event) => {
                event.target.setVolume(10);
                event.target.seekTo(this.start ? Number(this.start) : 0)
              }
            }
          });
        }
        getId = (url) => {
          var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
          var match = url.match(regExp);
          return (match&&match[7].length==11)? match[7] : false;
        }
      }
      const player = new Player();
      function onYouTubeIframeAPIReady() {
        // player = new YT.Player('player', {
        //   height: window.innerHeight,
        //   width: window.innerWidth,
        //   videoId: getId(decodeURIComponent(urlParams.get('youtube'))),
        //   playerVars: {
        //     'playsinline': 1,
        //     'autoplay': 0,
        //     'disablekb': 1,
        //     'modestbranding': true,
        //     'origin': 'https://sq-synced-videoplayer.glitch.me',
        //     'start': start ? Number(start) : 0
        //   },
        //   events: {
        //     'onReady': (event) => {
        //       console.log('ready');
        //       event.target.setVolume(10);
        //       event.target.seekTo(start ? Number(start) : 0)
        //     }
        //   }
        // });
        player.onYouTubeIframeAPIReady();
      }
    
    </script>
  </body>
</html>