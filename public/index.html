<html>
  <head>
    <style>
      html, body{margin: 0; padding: 0;}
      #status{
        position: absolute;
        top: 50px;
        left: 50px; 
        background: white;
        padding: 7 7;
      }
    </style>
  </head>
  <body>
    <div id="status"></div>
    <div id="player"></div>
    <script>
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
      const Responses = {
        LINK_ME: 'link-me',
        SET_VOLUME: 'set-volume',
        MUTE: 'mute',
        SYNC_TIME: 'sync-time',
        AUTO_SYNC: 'auto-sync'
      }
      const hostUrl = 'sq-video-player.glitch.me';
      class Player {
        constructor(){
          this.init();
        }
        init() {
          this.video = document.getElementById("videoFrame");
          this.urlParams = new URLSearchParams(window.location.search);      
          this.start = this.urlParams.get('start') || 0; 
          const volume = this.urlParams.get('volume');
          this.volume = volume || volume == '0' ? volume : '10';
          // document.getElementById('status').innerText = this.volume;
          this.mute = this.urlParams.get('mute') || 'false';
          var userStr = (this.urlParams.get("user") || "").split("-_-");
          window.user = {
            id: userStr[0],
            name: userStr[1]
          }
          this.setupWebsocket();
        }
        setupWebsocket(){
          return new Promise(resolve => {
            this.ws = new WebSocket('wss://' + hostUrl + '/');
            this.ws.onopen = (event) => {
              console.log("Websocket connected.");
              this.sendMessage({path: "user-video-player", data: window.user});
              resolve();
            };
            this.ws.onmessage = (event) => {
              if(typeof event.data === 'string'){
                this.parseMessage(event.data);
              }
            }
            this.ws.onclose =  (event) => {
              console.log("Websocket closed...");
              setTimeout(() => {
                if(window.isBanter) {
                  this.setupWebsocket();
                }else{
                  window.location.reload();
                } 
              }, 1000);
            };
          });
        } 
        parseMessage(msg) {
          const json = JSON.parse(msg);
          const vol = this.player.getVolume();
          switch(json.path) {
            case Responses.LINK_ME:
              if(json.data === window.user.id) {
                console.log("Websocket connected.");
                this.sendMessage({path: "user-video-player", data: window.user});
              }
              break;
            case Responses.SET_VOLUME:
              if(json.data >= 0 && json.data <= 100) {
                this.volume = Number(json.data);
                this.setVolume();
                this.setMute();
              }
              break;
            case Responses.AUTO_SYNC:
              this.autoSync = json.data;
              break;
            case Responses.MUTE:
              this.mute = json.data;
              this.setMute();
              break;
            case Responses.SYNC_TIME:
              const timediff = Math.abs(this.player.getCurrentTime() - json.data.currentTime);
              document.getElementById('status').innerHTML = this.player.getCurrentTime() + " - " + json.data.currentTime + " = " + timediff;
              if(timediff > 0.75 && this.autoSync) {
                 this.player.seekTo(json.data.currentTime);
              }
              break;
          }
        }
        sendMessage(msg){
          this.ws.send(JSON.stringify(msg));
        }
        onYouTubeIframeAPIReady() {
          new YT.Player('player', {
            height: window.innerHeight,
            width: window.innerWidth,
            videoId: this.getId(decodeURIComponent(this.urlParams.get('youtube'))),
            playerVars: {
              'playsinline': 1,
              'autoplay': 0,
              'disablekb': 1,
              'controls': 0,
              'modestbranding': true,
              'cc_load_policy': 1,
              'cc_lang_pref': 'en',
              'iv_load_policy': 3,
              'origin': 'https://sq-video-player.glitch.me',
              'start': this.start ? Number(this.start) : 0
            },
            events: {
              'onStateChange': (event) => {
                if(event.data == 2 && this.player) {
                  this.player.playVideo();
                }
              },
              'onReady': (event) => {
                this.player = event.target;
                this.setVolume();
                this.setMute();
                this.player.seekTo(Number(this.start));
                
              }
            }
          });
        }
        setMute() {
            if(this.mute == 'true' || this.volume == 0) {
              this.player.mute();
            }else{
              this.player.unMute();
            }
        }
        setVolume() {
            this.volume = Number(this.volume);
            this.player.setVolume(this.volume);
        }
        getId = (url) => {
          var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
          var match = url.match(regExp);
          return (match&&match[7].length==11)? match[7] : false;
        }
      }
      const player = new Player();
      function onYouTubeIframeAPIReady() {
        player.onYouTubeIframeAPIReady();
      }
    
    </script>
  </body>
</html>