<html>
  <head>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
      html, body{margin: 0; padding: 0;}
    </style>
  </head>
  <body>
    <div id="player"></div>
    <script>
      const Responses = {
        LINK_ME: 'link-me',
        SET_VOLUME: 'set-volume',
        MUTE: 'mute'
      }
      const hostUrl = 'sq-video-player.glitch.me';
      class Player {
        constructor(){
          this.init();
        }
        init() {
          this.video = document.getElementById("videoFrame");
          this.urlParams = new URLSearchParams(window.location.search);      
          this.start = this.urlParams.get('start') || 0; 
          this.volume = this.urlParams.has('volume') ? this.urlParams.get('volume') : '10';
          this.mute = this.urlParams.get('mute') || 'false';
          var userStr = (this.urlParams.get("user") || "").split("-_-");
          window.user = {
            id: userStr[0],
            name: userStr[1]
          }
          this.setupWebsocket();
        }
        setupWebsocket(){
          return new Promise(resolve => {
            this.ws = new WebSocket('wss://' + hostUrl + '/');
            this.ws.onopen = (event) => {
              console.log("Websocket connected.");
              this.sendMessage({path: "user-video-player", data: window.user});
              resolve();
            };
            this.ws.onmessage = (event) => {
              if(typeof event.data === 'string'){
                this.parseMessage(event.data);
              }
            }
            this.ws.onclose =  (event) => {
              console.log("Websocket closed...");
              setTimeout(() => {
                if(window.isBanter) {
                  this.setupWebsocket();
                }else{
                  window.location.reload();
                } 
              }, 1000);
            };
          });
        } 
        parseMessage(msg) {
          const json = JSON.parse(msg);
          const vol = this.player.getVolume();
          switch(json.path) {
            case Responses.LINK_ME:
              if(json.data === window.user.id) {
                console.log("Websocket connected.");
                this.sendMessage({path: "user-video-player", data: window.user});
              }
              break;
            case Responses.SET_VOLUME:
              if(json.data >= 0 && json.data <= 100) {
                this.player.setVolume(json.data);
              }
              break;
            case Responses.MUTE:
              if(json.data == 'true') {
                this.player.mute();
              }else{
                this.player.unMute();
              }
              break;
          }
        }
        sendMessage(msg){
          this.ws.send(JSON.stringify(msg));
        }
        onYouTubeIframeAPIReady() {
          new YT.Player('player', {
            height: window.innerHeight,
            width: window.innerWidth,
            videoId: this.getId(decodeURIComponent(this.urlParams.get('youtube'))),
            playerVars: {
              'playsinline': 1,
              'autoplay': 0,
              'disablekb': 1,
              'controls': 0,
              'modestbranding': true,
              'cc_load_policy': 1,
              'cc_lang_pref': 'en',
              'iv_load_policy': 3,
              'origin': 'https://sq-video-player.glitch.me',
              'start': this.start ? Number(this.start) : 0
            },
            events: {
              'onStateChange': (event) => {
                if(event.data == 2 && this.player) {
                  this.player.playVideo();
                }
              },
              'onReady': (event) => {
                this.player = event.target;
                this.player.setVolume(Number(this.volume));
                this.player.seekTo(Number(this.start));
                if(this.mute == 'true') {
                  this.player.mute();
                }else{
                  this.player.unMute();
                }
              }
            }
          });
        }
        getId = (url) => {
          var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
          var match = url.match(regExp);
          return (match&&match[7].length==11)? match[7] : false;
        }
      }
      const player = new Player();
      function onYouTubeIframeAPIReady() {
        player.onYouTubeIframeAPIReady();
      }
    
    </script>
  </body>
</html>