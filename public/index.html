<html>
  <head>
    <style>
      html, body{margin: 0; padding: 0;}
      #status{
        position: absolute;
        top: 50px;
        left: 50px; 
        background: white;
        padding: 7 7;
      }
    </style>
  </head>
  <body>
    <div id="status"></div>
    <div id="player"></div>
    <script src="./core.js"></script>
    <script src="./player.js"></script>
    <script>
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
//       const Responses = {
//         LINK_ME: 'link-me',
//         SET_VOLUME: 'set-volume',
//         MUTE: 'mute',
//         SKIP_BACK: 'skip-back',
//         SKIP_FORWARD: 'skip-forward',
//         SYNC_TIME: 'sync-time',
//         AUTO_SYNC: 'auto-sync',
//         MEASURE_LATENCY: 'measure-latency',
//         PLAYBACK_UPDATE: 'playback-update'
//       }
      
      
      
      
      
//       const hostUrl = 'sq-video-player.glitch.me';
//       class Player {
//         constructor(){
//           this.hostUrl = 'sq-video-player.glitch.me';
//           this.currentScript = Array.from(document.getElementsByTagName('script')).slice(-1)[0];
//             // if(this.core.params.playlist) {
//             //   const url = `https://${this.hostUrl}/playlist/?instance=${this.core.params.instance}&playlist=${this.core.params.playlist}&user=${window.user.id}-_-${window.user.name}`;
//             //   this.core.setupBrowserElement(url);
//             // }else{
//            // const url = `https://${this.hostUrl}/?youtube=${encodeURIComponent('https://www.youtube.com/watch?v=L_LUpnjgPso')}&start=0&playlist=${this.core.params.playlist}&user=${window.user.id}-_-${window.user.name}`;
//            // this.core.setupBrowserElement(url);
//             // }
//           this.init();
//         }
//         async init() {
//            this.core = window.videoPlayerCore;
//            this.core.parseParams(this.currentScript);
//            await this.core.init(this.hostUrl);
//            await this.core.setupWebsocket();
//            this.core.sendMessage({path: "instance", data: this.core.params.instance, u: window.user});
//            this.core.setupLatencyMeasure();
//           // this.currentLatency = 0;
//           // this.video = document.getElementById("videoFrame");
//           // this.urlParams = new URLSearchParams(window.location.search);      
//           // this.start = this.urlParams.get('start') || 0; 
//           // const volume = this.urlParams.get('volume');
//           // this.volume = volume || volume == '0' ? volume : '10';
//           // // document.getElementById('status').innerText = this.volume;
//           // this.mute = this.urlParams.get('mute') || 'false';
//           // var userStr = (this.urlParams.get("user") || "").split("-_-");
//           // window.user = {
//           //   id: userStr[0],
//           //   name: userStr[1]
//           // }
//           // await this.setupWebsocket();
//           // this.setupLatencyMeasure();
//         }
//         setupWebsocket(){
//           return new Promise(resolve => {
//             this.ws = new WebSocket('wss://' + hostUrl + '/');
//             this.ws.onopen = (event) => {
//               console.log("Websocket connected.");
//               this.sendMessage({path: "user-video-player", data: window.user});
//               resolve();
//             };
//             this.ws.onmessage = (event) => {
//               if(typeof event.data === 'string'){
//                 this.parseMessage(event.data);
//               }
//             }
//             this.ws.onclose =  (event) => {
//               console.log("Websocket closed...");
//               setTimeout(() => {
//                 if(window.isBanter) {
//                   this.setupWebsocket();
//                 }else{
//                   window.location.reload();
//                 } 
//               }, 1000);
//             };
//           });
//         } 
//         parseMessage(msg) {
//           const json = JSON.parse(msg);
//           const vol = this.player.getVolume();
//           switch(json.path) {
//             case Responses.LINK_ME:
//               if(json.data === window.user.id) {
//                 console.log("Websocket connected.");
//                 this.sendMessage({path: "user-video-player", data: window.user});
//               }
//               break;
//             case Responses.SET_VOLUME:
//               if(json.data >= 0 && json.data <= 100) {
//                 this.volume = Number(json.data);
//                 this.setVolume();
//                 this.setMute();
//               }
//               break;
//             case Responses.SKIP_BACK:
//               this.player.seekTo(this.player.getCurrentTime() - 0.3);
//               break;
//             case Responses.SKIP_FORWARD:
//               this.player.seekTo(this.player.getCurrentTime() + 0.3);
//               break;
//             case Responses.AUTO_SYNC:
//               this.autoSync = json.data;
//               break;
//             // case Responses.SYNC_TIME:
//             //     
//             //   break;
//             case Responses.PLAYBACK_UPDATE:
//                 this.playerData = json.data.video;
//                 if(json.data.type === "set-track") {
//                   // const url = this.player.playlist[json.data.video.currentTrack].link;
//                   // this.player.loadVideoById(this.getId(url), 0);
//                   this.playVidya(json.data.video.currentTrack, json.data.video.currentTime, true);
//                 }
//               break;
//             case Responses.MUTE:
//               this.mute = json.data;
//               this.setMute();
//               break;
//             case Responses.MEASURE_LATENCY:
//               if(this.measureLatencyResolve){
//                 this.measureLatencyResolve();
//                 this.measureLatencyResolve = null;
//               }
//             case Responses.SYNC_TIME:
//               const timediff = Math.abs(this.player.getCurrentTime() - json.data.currentTime + this.currentLatency);
//               document.getElementById('status').innerHTML = this.player.getCurrentTime() + " - " + json.data.currentTime + " = " + timediff;
//               if(timediff > 0.75 && this.autoSync) {
//                  this.player.seekTo(json.data.currentTime + this.currentLatency);
//               }
//               this.playVidya(json.data.currentTrack, json.data.currentTime);
//               break;
//           }
//         }
//         playVidya(currentTrack, currentTime, force) {
//           if(this.playerData) {
//             if(this.lastUrl !== this.playerData.playlist[currentTrack].link || force) {
//               const url = this.playerData.playlist[json.data.video.currentTrack].link;
//               this.player.loadVideoById(this.getId(url), currentTime);
//               console.log("Playing video:", url);
//             }
//             this.lastUrl = this.playerData.playlist[currentTrack].link;
//           }else{
//             console.log("No player data!");
//           }
//         }
//         sendMessage(msg){
//           this.ws.send(JSON.stringify(msg));
//         }
//         onYouTubeIframeAPIReady() {
//           new YT.Player('player', {
//             height: window.innerHeight,
//             width: window.innerWidth,
//             videoId: this.getId(decodeURIComponent(this.core.params.youtube)),
//             playerVars: {
//               'playsinline': 1,
//               'autoplay': 0,
//               'disablekb': 1,
//               'controls': 0,
//               'modestbranding': true,
//               'cc_load_policy': 1,
//               'cc_lang_pref': 'en',
//               'iv_load_policy': 3,
//               'origin': 'https://sq-video-player.glitch.me',
//               'start': this.start ? Number(this.start) : 0
//             },
//             events: {
//               'onStateChange': (event) => {
//                 // if(event.data == 2 && this.player) {
//                 //   this.player.playVideo();
//                 // }
//               },
//               'onReady': (event) => {
//                 this.player = event.target;
//                 this.setVolume();
//                 this.setMute();
//                 this.player.seekTo(Number(this.start));
                
//               }
//             }
//           });
//         }
//         setMute() {
//             if(this.mute == 'true' || this.volume == 0) {
//               this.player.mute();
//             }else{
//               this.player.unMute();
//             }
//         }
//         setupLatencyMeasure() {
//           const measure = async () => {
//             const time = Date.now();
//             await this.measureLatency();
//             this.currentLatency = (Date.now()-time)/2;
//           };
//           setInterval(measure , 5000);
//           measure();
//         }
//         measureLatency() {
//           return new Promise(resolve=>{
//             this.sendMessage({path: Commands.MEASURE_LATENCY});
//             this.measureLatencyResolve = resolve;
//           })
//         }
//         setVolume() {
//             this.volume = Number(this.volume);
//             this.player.setVolume(this.volume);
//         }
//         getId = (url) => {
//           var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
//           var match = url.match(regExp);
//           return (match&&match[7].length==11)? match[7] : false;
//         }
//       }
      const player = new Player();
      function onYouTubeIframeAPIReady() {
        player.onYouTubeIframeAPIReady();
      }
    
    </script>
  </body>
</html>